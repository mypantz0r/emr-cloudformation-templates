AWSTemplateFormatVersion: 2010-09-09
Parameters:
  SubnetId:
    Type: String
  ClusterName:
    Type: String
    Default: Three Node Cluster
  EmrRelease:
    Type: String
    Default: emr-6.8.0
    AllowedValues:
      - emr-6.8.0
      - emr-5.33.1
Resources:
  EmrCluster:
    Type: 'AWS::EMR::Cluster'
    Properties:
      Applications:
        - Name: Spark
        - Name: Livy
        - Name: JupyterEnterpriseGateway
        - Name: Hive
        - Name: Hue
        - Name: Presto
      BootstrapActions:
        - Name: Instrument-Model-Dependencies
          ScriptBootstrapAction:
            Path: 's3://fb-dev-edw-artifacts-needles-io-ap-southeast-2/configs/instrument_model_bootstrap.sh'
      EbsRootVolumeSize: '50'
      Name: !Ref ClusterName
      JobFlowRole: EMR_EC2_DefaultRole
      ServiceRole: EMR_DefaultRole
      ReleaseLabel: !Ref EmrRelease
      VisibleToAllUsers: true
      LogUri: 's3://fb-dev-athena-datalake-needles-io-ap-southeast-2/emr_logs/'
      Instances:
        TerminationProtected: false
        Ec2SubnetId: !Ref SubnetId
        CoreInstanceFleet:
          InstanceTypeConfigs:
            - InstanceType: m5.xlarge
              WeightedCapacity: 1
            - InstanceType: r6gd.xlarge
              WeightedCapacity: 1
            - InstanceType: m5.2xlarge
              WeightedCapacity: 2
            - InstanceType: m5a.2xlarge
              WeightedCapacity: 2
          Name: !Ref 'AWS::StackName'
          TargetSpotCapacity: '3'
          LaunchSpecifications:
            SpotSpecification:
              TimeoutAction: SWITCH_TO_ON_DEMAND
              TimeoutDurationMinutes: 15
              AllocationStrategy: capacity-optimized
        MasterInstanceFleet:
          InstanceTypeConfigs:
            - InstanceType: c4.large
            - InstanceType: m4.large
          Name: !Ref 'AWS::StackName'
          TargetOnDemandCapacity: '1'
      Configurations:
        - Classification: spark-hive-site
          ConfigurationProperties:
            hive.metastore.client.factory.class: com.amazonaws.glue.catalog.metastore.AWSGlueDataCatalogHiveClientFactory
            hive.metastore.schema.verification: false
        - Classification: presto-connector-hive
          ConfigurationProperties:
            hive.metastore: glue
        - Classification: spark-env
          ConfigurationProperties:
            hive.metastore: glue
Outputs:
  ClusterId:
    Value: !Ref EmrCluster
    Description: The ID of the EMR Cluster
Rules: {}
